Last updated DDK 2016-10-03

OVERVIEW: 
This directory contains files and folders used to manually refine the output of an automated segmentation algorithm.


REQUIREMENTS:
1) The image processing program Fiji, available at https://fiji.sc/
2) The Fiji macro batchImportROIs.txt, available at https://github.com/danieldkato/cse2Fiji/blob/master/batchImportROIs.txt (commit 3274e4a)


INPUTS:
1) A set of ROIs created by an automated segmentation algorithm. Each ROI should be saved as a 2-column .txt file, where each row corresponds to a point defining the contour of the ROI; the first column should give a point's X-coordinate, and the second column should give the point's Y-coordinate. All .txt files for ROIs associated with the same multi-page TIFF should be saved in the same directory for efficient batch importing.


OUTPUTS:
1) A set of manually-refined ROIs. These can be saved as a .zip file [this should probably ultimately be changed to make it more versatile].


INSTRUCTIONS:
To view autpmatically-drawn ROIs:
1) Automatically segment a motion-corrected, multi-page TIFF using a pipeline of choice in the previous data-processing step. Ensure that each ROI generated by the algorith is saved as a 2-column .txt file, where each row corresponds to a point defining the contour of the ROI; the first column should give a point's X-coordinate, and the second column should give the point's Y-coordinate.
2) Make sure that the Batch Import ROIs macro is installed (see comments in batchImportROIs.txt for installation instructions)
3) Launch an instance of ImageJ or Fiji and open the original motion-corrected multi-page TIFF 
4) Optionally, subtract the mean image from the multi-page TIFF to aid visualization
	-To create the mean image, go to Image>Stacks>Z Project..., enter the first and last frames as the start and stop slices, respectively, set 'Projection Type' to 'Average Intensity' and press 'OK'.
	-Go to Process>Image Calculator..., set 'Image 1' to the mutli-page TIFF, set 'Image 2' to the mean image, set 'Operation' to 'Subtract', and press 'OK'.
5) Go to Plugins>Macros>Batch Import ROIs... and select that movie's Coor2txt directory. This will open ImageJ/Fiji's ROI manager and load the ROIs.
6) Check 'Show All' in ROI Manager to view all ROIs simultaneously. Automatically-drawn ROIs from the previous data-processing step should have a yellow stroke by default.
7) Scroll through the mean-subtracted mutli-page TIFF one frame at a time. This will make fewer potential soma visible at any given time and aid in segmentation.   

To add ROIs:
8) While scrolling through the multi-page TIFF, use the 'Freehand Selections' tool to inscribe a region of interest (ROI) around any putative cell soma not already inscribed in an automatically-drawn ROI. 
9) After inscribing each putative cell soma, press 'Add' in ROI Manager.
10) After adding each newly-drawn ROI to the ROI Manager, open Properties... and set the stroke color to green in order to distinguish it from the automatically-drawn ROIs. 

To mark ROIs for deletion: 
11) Select the ROI for deletion in ROI Manager, open Properties... and set the stroke color to red in order to distinguish it form automatically-drawn ROIs that should be retained.

12) Once all refinements have been made, navigate to More>>Save... in ROI manager, and save the ROIs as 'semiAutoROIs.zip'.

To review manually-refined ROIs in a subsequent ImageJ session:
1) Open the motion-corrected multi-page TIFF in ImageJ or Fiji.
2) Open Analyze>Tools>ROI Manager...
3) In ROI Manager, go to More>>Open... and select the .zip file containing the ROIs created for that movie. 


METADATA PARAMETERS:
The metadata associated with output from this data processing step should have the following format:

manual_ROI_refinement_metadata = 
{'inputs':{'auto ROIs':'path\to\automatically\drawn\ROIs'},
 'outputs': {'manually refined ROIs (.zip)':'path\to\semiAutoROIs.zip'},
 'dependencies': [path\to\Fiji (version)],
 'parameters': {}
}